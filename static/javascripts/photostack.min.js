/**
 * photostack.js v1.0.0
 * http://www.codrops.com
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 * 
 * Copyright 2014, Codrops
 * http://www.codrops.com
 */
(function(k){function m(a,b){for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);return a}function z(a){for(var b=[],e=a.length,A=a[0].length,f=0;f<e;f++)b=b.concat(a[f]);a=b.length;for(var g;a;)g=Math.floor(Math.random()*a--),f=b[a],b[a]=b[g],b[g]=f;a=[];for(g=f=0;g<e;g++){for(var c=[],d=0;d<A;d++)c.push(b[f]),f++;a.push(c)}return a}function d(a,b){this.el=a;this.inner=this.el.querySelector("div");this.allItems=[].slice.call(this.inner.children);if(this.allItemsCount=this.allItems.length)this.items=
[].slice.call(this.inner.querySelectorAll("figure:not([data-dummy])")),this.itemsCount=this.items.length,this.current=0,this.options=m({},this.options),m(this.options,b),this._init()}Modernizr.addTest("csstransformspreserve3d",function(){var a=Modernizr.prefixed("transformStyle"),b;if(!a)return!1;a=a.replace(/([A-Z])/g,function(a,b){return"-"+b.toLowerCase()}).replace(/^ms-/,"-ms-");Modernizr.testStyles("#modernizr{"+a+":preserve-3d;}",function(e,d){b=k.getComputedStyle?getComputedStyle(e,null).getPropertyValue(a):
""});return"preserve-3d"===b});var n=Modernizr.csstransitions,l=Modernizr.csstransformspreserve3d,p={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"}[Modernizr.prefixed("transition")];d.prototype.options={};d.prototype._init=function(){this.currentItem=this.items[this.current];this._addNavigation();this._getSizes();this._initEvents()};d.prototype._addNavigation=function(){this.nav=document.createElement("nav");
for(var a="",b=0;b<this.itemsCount;++b)a+="<span></span>";this.nav.innerHTML=a;this.el.appendChild(this.nav);this.navDots=[].slice.call(this.nav.children)};d.prototype._initEvents=function(){var a=this,b=classie.hasClass(this.el,"photostack-start"),e=function(){var d=function(){n&&classie.addClass(a.el,"photostack-transition")};b?(this.removeEventListener("click",e),classie.removeClass(a.el,"photostack-start"),d()):(a.openDefault=!0,setTimeout(d,25));a.started=!0;a._showPhoto(a.current)};b?(this._shuffle(),
this.el.addEventListener("click",e)):e();this.navDots.forEach(function(b,e){b.addEventListener("click",function(){if(e===a.current)a._rotateItem();else{var b=function(){a._showPhoto(e)};a.flipped?a._rotateItem(b):b()}})});k.addEventListener("resize",function(){a._resizeHandler()})};d.prototype._resizeHandler=function(){var a=this;this._resizeTimeout&&clearTimeout(this._resizeTimeout);this._resizeTimeout=setTimeout(function(){a._resize();a._resizeTimeout=null},100)};d.prototype._resize=function(){var a=
this,b=function(){a._shuffle(!0)};this._getSizes();this.started&&this.flipped?this._rotateItem(b):b()};d.prototype._showPhoto=function(a){if(this.isShuffling)return!1;this.isShuffling=!0;classie.hasClass(this.currentItem,"photostack-flip")&&(this._removeItemPerspective(),classie.removeClass(this.navDots[this.current],"flippable"));classie.removeClass(this.navDots[this.current],"current");classie.removeClass(this.currentItem,"photostack-current");this.current=a;this.currentItem=this.items[this.current];
classie.addClass(this.navDots[this.current],"current");this.currentItem.querySelector(".photostack-back")&&classie.addClass(this.navDots[a],"flippable");this._shuffle()};d.prototype._shuffle=function(a){var b=a?1:this.currentItem.getAttribute("data-shuffle-iteration")||1;if(0>=b||!this.started||this.openDefault)b=1;this.openDefault&&(classie.addClass(this.currentItem,"photostack-flip"),this.isShuffling=this.openDefault=!1);var e=Math.ceil(this.sizes.inner.width/(.5*this.sizes.item.width)),d=Math.ceil(this.sizes.inner.height/
(.5*this.sizes.item.height)),f=(e*this.sizes.item.width*.5+this.sizes.item.width/2-this.sizes.inner.width)/2,g=(d*this.sizes.item.height*.5+this.sizes.item.height/2-this.sizes.inner.height)/2,c=this,x=function(){--b;for(var a=[],h=0;h<d;++h)for(var l=a[h]=[],q=0;q<e;++q){var k=.5*q*c.sizes.item.width-f,m=.5*h*c.sizes.item.height-g,u=0,v=0;if(c.started&&0===b){var w=c._isOverlapping({x:k,y:m});if(w.overlapping)switch(u=w.noOverlap.x,v=w.noOverlap.y,Math.floor(3*Math.random())){case 0:u=0;break;case 1:v=
0}}l[q]={x:k+u,y:m+v}}var a=z(a),r=0,t=0,y=0;c.allItems.forEach(function(f,g){r===e-1?(t=t===d-1?0:t+1,r=1):++r;Math.random();Math.random();var h=a[t][r-1],k=h.x,h=h.y,l=function(){++y;n&&this.removeEventListener(p,l);y===c.allItemsCount&&(0<b?x.call():(classie.addClass(c.currentItem,"photostack-flip"),c.isShuffling=!1,"function"===typeof c.options.callback&&c.options.callback(c.currentItem)))};c.items.indexOf(f)===c.current&&c.started&&0===b?(c.currentItem.style.WebkitTransform="translate("+c.centerItem.x+
"px,"+c.centerItem.y+"px) rotate(0deg)",c.currentItem.style.msTransform="translate("+c.centerItem.x+"px,"+c.centerItem.y+"px) rotate(0deg)",c.currentItem.style.transform="translate("+c.centerItem.x+"px,"+c.centerItem.y+"px) rotate(0deg)",c.currentItem.querySelector(".photostack-back")&&c._addItemPerspective(),classie.addClass(c.currentItem,"photostack-current")):(f.style.WebkitTransform="translate("+k+"px,"+h+"px) rotate("+Math.floor(71*Math.random()+-35)+"deg)",f.style.msTransform="translate("+k+
"px,"+h+"px) rotate("+Math.floor(71*Math.random()+-35)+"deg)",f.style.transform="translate("+k+"px,"+h+"px) rotate("+Math.floor(71*Math.random()+-35)+"deg)");c.started&&(n?f.addEventListener(p,l):l())})};x.call()};d.prototype._getSizes=function(){this.sizes={inner:{width:this.inner.offsetWidth,height:this.inner.offsetHeight},item:{width:this.currentItem.offsetWidth,height:this.currentItem.offsetHeight}};this.centerItem={x:this.sizes.inner.width/2-this.sizes.item.width/2,y:this.sizes.inner.height/
2-this.sizes.item.height/2}};d.prototype._isOverlapping=function(a){var b=this.sizes.item.width+this.sizes.item.width/3,e=this.sizes.item.height+this.sizes.item.height/3,d=this.sizes.inner.width/2-b/2,f=this.sizes.inner.height/2-e/2,g=this.sizes.item.width,c=this.sizes.item.height;if(!(a.x+g<d||a.x>d+b||a.y+c<f||a.y>f+e)){var k=.5>Math.random(),l=Math.floor(Math.random()*(g/4+1)),h=Math.floor(Math.random()*(c/4+1));return{overlapping:!0,noOverlap:{x:k?-1*(a.x-d+g)-l:d+b-(a.x+g)+g+l,y:k?-1*(a.y-f+
c)-h:f+e-(a.y+c)+c+h}}}return{overlapping:!1}};d.prototype._addItemPerspective=function(){classie.addClass(this.el,"photostack-perspective")};d.prototype._removeItemPerspective=function(){classie.removeClass(this.el,"photostack-perspective");classie.removeClass(this.currentItem,"photostack-flip")};d.prototype._rotateItem=function(a){if(classie.hasClass(this.el,"photostack-perspective")&&!this.isRotating&&!this.isShuffling){this.isRotating=!0;var b=this,d=function(){n&&l&&this.removeEventListener(p,
d);b.isRotating=!1;"function"===typeof a&&a()};this.flipped?(classie.removeClass(this.navDots[this.current],"flip"),l?(this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)"):classie.removeClass(this.currentItem,"photostack-showback")):(classie.addClass(this.navDots[this.current],"flip"),l?(this.currentItem.style.WebkitTransform="translate("+
this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)"):classie.addClass(this.currentItem,"photostack-showback"));this.flipped=!this.flipped;n&&l?this.currentItem.addEventListener(p,d):d()}};k.Photostack=d})(window);